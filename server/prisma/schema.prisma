// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  password                 String?   // Optional for OAuth users
  name                     String
  displayName              String?
  avatarColor              String?   @default("indigo")
  avatarUrl                String?   // Custom profile avatar URL
  role                     String    @default("user") // "user", "moderator", "admin"
  preferredStudyLanguage   String    @default("ja") // Always 'ja' (Japanese only)
  preferredNativeLanguage  String    @default("en")
  proficiencyLevel         String    @default("beginner") // 'beginner', 'intermediate', 'advanced', 'native'
  onboardingCompleted      Boolean   @default(false)
  seenSampleContentGuide   Boolean   @default(false) // Pulse point: Has user seen the sample content guide?
  seenCustomContentGuide   Boolean   @default(false) // Pulse point: Has user seen the custom content creation guide?
  emailVerified            Boolean   @default(false)
  emailVerifiedAt          DateTime?

  // OAuth fields
  googleId                 String?   @unique

  // Subscription fields
  tier                     String    @default("free") // "free", "pro"
  stripeCustomerId         String?   @unique
  stripeSubscriptionId     String?   @unique
  stripeSubscriptionStatus String?   // "active", "canceled", "past_due", "incomplete"
  stripePriceId            String?   // Track which price they're on
  subscriptionStartedAt    DateTime?
  subscriptionExpiresAt    DateTime?
  subscriptionCanceledAt   DateTime?
  isTestUser               Boolean   @default(false) // Test users can access $0.01/month test tier

  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  episodes                 Episode[]
  courses                  Course[]
  inviteCode               InviteCode?
  generationLogs           GenerationLog[]
  emailVerificationTokens  EmailVerificationToken[]
  passwordResetTokens      PasswordResetToken[]
  subscriptionEvents       SubscriptionEvent[]
  oauthAccounts            OAuthAccount[]

  @@index([email])
  @@index([role])
  @@index([emailVerified])
  @@index([googleId])
  @@index([tier])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([isTestUser])
}

model InviteCode {
  id        String    @id @default(uuid())
  code      String    @unique
  usedBy    String?   @unique // User ID who used it
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User? @relation(fields: [usedBy], references: [id])

  @@index([code])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model SubscriptionEvent {
  id            String   @id @default(uuid())
  userId        String
  eventType     String   // "subscribed", "upgraded", "downgraded", "canceled", "reactivated"
  fromTier      String?
  toTier        String
  stripeEventId String?  @unique
  metadata      Json?
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("subscription_events")
}

model Episode {
  id             String   @id @default(uuid())
  userId         String
  title          String
  sourceText     String   @db.Text
  targetLanguage String   // Language code: 'ja'
  nativeLanguage String   // User's native language
  jlptLevel      String?  // Optional JLPT level (N5-N1) for dialogue generation
  autoGenerateAudio Boolean @default(true)
  status         String   @default("draft") // draft, generating, ready, error
  isSampleContent Boolean @default(false) // Pre-generated sample content

  // Legacy single-speed audio (for backward compatibility)
  audioUrl       String?
  audioSpeed     String?  @default("medium") // Legacy: very-slow, slow, medium, normal

  // Multi-speed audio URLs
  audioUrl_0_7   String?  // Slow (0.7x)
  audioUrl_0_85  String?  // Medium (0.85x)
  audioUrl_1_0   String?  // Normal (1.0x)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  dialogue       Dialogue?
  images         Image[]
  courseEpisodes CourseEpisode[]

  @@index([userId])
  @@index([status])
}

model Dialogue {
  id        String   @id @default(uuid())
  episodeId String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  episode   Episode    @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  sentences Sentence[]
  speakers  Speaker[]

  @@index([episodeId])
}

model Speaker {
  id            String  @id @default(uuid())
  dialogueId    String
  name          String
  voiceId       String  // TTS voice ID (Google or Polly)
  voiceProvider String? @default("google") // "google" | "polly"
  proficiency   String  // beginner, intermediate, advanced, native
  tone          String  // casual, polite, formal
  gender        String? // male or female (for avatar matching)
  color         String? // For UI differentiation
  avatarUrl     String? // URL to speaker avatar image

  dialogue  Dialogue   @relation(fields: [dialogueId], references: [id], onDelete: Cascade)
  sentences Sentence[]

  @@index([dialogueId])
}

model Sentence {
  id          String   @id @default(uuid())
  dialogueId  String
  speakerId   String
  order       Int
  text        String   @db.Text
  translation String   @db.Text

  // Language-specific metadata stored as JSON
  // Structure: { japanese?: { kanji, kana, furigana } }
  metadata    Json

  // Legacy single-speed timing (for backward compatibility)
  audioUrl    String?
  startTime   Int?     // milliseconds
  endTime     Int?     // milliseconds

  // Multi-speed timings
  startTime_0_7  Int?  // milliseconds at 0.7x speed
  endTime_0_7    Int?  // milliseconds at 0.7x speed
  startTime_0_85 Int?  // milliseconds at 0.85x speed
  endTime_0_85   Int?  // milliseconds at 0.85x speed
  startTime_1_0  Int?  // milliseconds at 1.0x speed
  endTime_1_0    Int?  // milliseconds at 1.0x speed

  variations  Json?    // Array of alternative phrasings
  selected    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dialogue    Dialogue @relation(fields: [dialogueId], references: [id], onDelete: Cascade)
  speaker     Speaker  @relation(fields: [speakerId], references: [id])

  @@index([dialogueId])
  @@index([order])
}

model Image {
  id               String   @id @default(uuid())
  episodeId        String
  url              String
  prompt           String   @db.Text
  order            Int
  sentenceStartId  String?
  sentenceEndId    String?
  createdAt        DateTime @default(now())

  episode          Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@index([episodeId])
  @@index([order])
}

// Pimsleur-style Audio Course Models

model Course {
  id                       String   @id @default(uuid())
  userId                   String
  title                    String
  description              String?  @db.Text
  status                   String   @default("draft") // draft, generating, ready, error
  isSampleContent          Boolean  @default(false) // Pre-generated sample content
  isTestCourse             Boolean  @default(false) // Admin test courses for Script Lab
  nativeLanguage           String   // L1 (e.g., 'en')
  targetLanguage           String   // L2 (always 'ja')
  maxLessonDurationMinutes Int      @default(30)
  l1VoiceId                String   // English narrator voice
  l1VoiceProvider          String?  @default("google") // "google" | "polly"
  jlptLevel                String?  // Target JLPT level: N5, N4, N3, N2, N1 (null = no specific level)
  speaker1Gender           String   @default("male") // Gender for first dialogue speaker: 'male' or 'female'
  speaker2Gender           String   @default("female") // Gender for second dialogue speaker: 'male' or 'female'
  speaker1VoiceId          String?  // Specific TTS voice ID for speaker 1 (overrides gender default)
  speaker1VoiceProvider    String?  @default("google") // "google" | "polly"
  speaker2VoiceId          String?  // Specific TTS voice ID for speaker 2 (overrides gender default)
  speaker2VoiceProvider    String?  @default("google") // "google" | "polly"
  scriptJson               Json?    // Pipeline data: { _pipelineStage, _exchanges, _scriptUnits } or legacy flat array
  scriptUnitsJson          Json?    // Flat LessonScriptUnit[] for audio assembly (separate from pipeline data)
  approxDurationSeconds    Int?     // Flattened from Lesson
  audioUrl                 String?  // Flattened from Lesson
  timingData               Json?    // Timing data for each script unit: { unitIndex, startTime, endTime }[]
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  user                     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  coreItems                CourseCoreItem[]
  courseEpisodes           CourseEpisode[]
  lineAudioRenderings      LineAudioRendering[]

  @@index([userId])
  @@index([status])
  @@index([isTestCourse])
}

model CourseEpisode {
  id        String @id @default(uuid())
  courseId  String
  episodeId String
  order     Int

  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@unique([courseId, episodeId])
  @@index([courseId])
  @@index([episodeId])
}

model CourseCoreItem {
  id                String  @id @default(uuid())
  courseId          String
  textL2            String
  readingL2         String? // kana
  translationL1     String
  complexityScore   Float
  sourceEpisodeId   String?
  sourceSentenceId  String?
  sourceUnitIndex   Int?    // Index in Course.scriptJson where this vocabulary appears
  components        Json?   // Pimsleur backward-build components: PhraseComponent[]

  course            Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

// Speaker Avatar Models - Store avatars in GCS

model SpeakerAvatar {
  id          String   @id @default(uuid())
  filename    String   @unique // e.g., "ja-female-casual.jpg"
  croppedUrl  String   // GCS public URL for cropped avatar
  originalUrl String   // GCS public URL for original/uncropped version
  language    String   // Language code: 'ja'
  gender      String   // 'male' or 'female'
  tone        String   // 'casual', 'polite', 'formal'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([filename])
  @@index([language, gender, tone])
}

// Feature Flags - Control visibility of content types for non-admin users

model FeatureFlag {
  id                           String   @id @default(uuid())
  dialoguesEnabled             Boolean  @default(true)
  audioCourseEnabled           Boolean  @default(true)
  updatedAt                    DateTime @updatedAt

  @@map("feature_flags")
}

// Admin Audit Log - Track admin actions for compliance and security

model AdminAuditLog {
  id           String   @id @default(uuid())
  adminUserId  String   // Admin who performed action
  action       String   // "impersonate_start", "impersonate_end", etc.
  targetUserId String?  // User being impersonated (if applicable)
  metadata     Json?    // Additional context (e.g., IP, user agent)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// Generation Log - Track content generation events for rate limiting
// Persists even if content is deleted to prevent quota gaming

model GenerationLog {
  id          String   @id @default(uuid())
  userId      String
  contentType String   // "dialogue" or "course"
  contentId   String?  // Optional reference to generated content
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("generation_logs")
}

// Line Audio Rendering - Per-line TTS test results from Script Lab

model LineAudioRendering {
  id        String   @id @default(uuid())
  courseId  String
  unitIndex Int
  text      String   @db.Text
  speed     Float    @default(1.0)
  voiceId   String
  audioUrl  String
  createdAt DateTime @default(now())

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId, unitIndex])
  @@map("line_audio_renderings")
}

// Sentence Script Test - Persisted results from Script Lab sentence-script generation

model SentenceScriptTest {
  id                    String   @id @default(uuid())
  userId                String
  sentence              String   @db.Text
  translation           String?  @db.Text
  targetLanguage        String   @default("ja")
  nativeLanguage        String   @default("en")
  jlptLevel             String?
  l1VoiceId             String
  l2VoiceId             String
  promptTemplate        String   @db.Text
  unitsJson             Json?
  rawResponse           String   @db.Text
  estimatedDurationSecs Float?
  parseError            String?
  createdAt             DateTime @default(now())

  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([sentence])
  @@map("sentence_script_tests")
}

// OAuth Account - Store OAuth provider tokens and metadata

model OAuthAccount {
  id           String    @id @default(uuid())
  userId       String
  provider     String    // "google", "github", etc.
  providerId   String    // Provider's unique ID for the user
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}
