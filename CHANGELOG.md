# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## Unreleased

### Added

- **[feat]** Full UI impersonation support with useEffectiveUser hook - when admins impersonate users via the viewAs parameter, the entire UI now reflects the impersonated user's preferences including language preferences (study language, native language), form defaults (course generator, narrow listening), navigation language indicator, and user avatar/name/display info; created useEffectiveUser hook that fetches impersonated user data and provides effectiveUser for UI personalization while keeping useAuth() for authentication/authorization logic
- **[feat]** Admin impersonation preserved across content creation workflow - admins can now create content for users while impersonating them; viewAs query parameter is maintained through all navigation paths including: library empty states → create page → content type forms → API calls → success navigation; enables admins to generate dialogues, audio courses, narrow listening packs, processing instruction sessions, and lexical chunk packs on behalf of users without losing impersonation context
- **[chore]** Diagnostic scripts for debugging content generation - added 34 utility scripts for monitoring and managing content generation: check-\*-queue.ts (queue status monitoring), delete-course.ts (safe course deletion), trigger-episode-audio.ts (manual audio generation), find-yuriy-courses.ts, get-course-details.ts, list-all-users.ts, and various user/content inspection utilities

### Fixed

- **[fix]** Batched TTS audio clipping fixed with silence detection - resolved issue where speech was cut off at segment boundaries in batched audio courses; Google TTS mark timepoints don't precisely align with actual speech timing (can be off by 0.5-1.5 seconds), causing splits to cut into words; now uses ffmpeg silence detection to find actual speech boundaries within ±2 seconds of each mark, splitting at silence midpoints instead of raw mark times; eliminates clipping while maintaining batching optimization that reduces API calls by 99%
- **[fix]** Course page crash when accessing undefined script unit - added null check before accessing unit.type property to prevent "Cannot read properties of undefined (reading 'type')" error; handles edge case where timing data references script units that don't exist at the expected index
- **[fix]** Admin impersonation lost during course status polling - fixed bug where viewAs parameter was not passed to course status endpoint during generation polling; admins now stay in impersonation mode when viewing generating courses; resolves "something went wrong" error when admins try to monitor course generation while impersonating users
- **[fix]** Audio course duration accuracy and batching consistency - corrected estimatedSecondsPerExchange from 35s to 90s to accurately reflect actual course length (previous estimate caused 30-minute courses to generate as 79 minutes, 2.7x longer than requested); aligned course batching with dialogue batching by placing SSML marks BEFORE text instead of AFTER to prevent timing drift accumulation in long batches and ensure audio segments are split correctly at the START of each unit; resolves audio splitting issues where speech was being cut off at segment boundaries
- **[fix]** Impersonated user avatar and info now shown in UserMenu - fixed bug where admin's avatar was displayed instead of the impersonated user's when using view-as mode; UserMenu now correctly shows the impersonated user's avatar, name, and role; "Viewing as" overlay badge now persists across all pages (Library, Create, etc.) as long as viewAs parameter is present
- **[fix]** Admin impersonation lost when clicking navigation links - fixed critical bug where viewAs query parameter was not preserved in Layout navigation links (logo, Library, Create buttons); admins would lose impersonation context when clicking any nav link; all navigation now preserves viewAs parameter; added visual "Viewing as: [name]" indicator badge in header to clearly show active impersonation; fetches and displays impersonated user's name for admin clarity
- **[fix]** Google TTS language code mismatch causing audio generation failures - fixed issue where 2-letter language codes (e.g., "fr") didn't match Google TTS voice format requirements (e.g., "fr-FR"); now extract full language code directly from voice ID ("fr-FR-Neural2-A" → "fr-FR") to ensure API compatibility; resolves "Requested language code doesn't match voice's language code" errors that blocked audio generation for French and other non-English content
- **[fix]** Admin impersonation now works across all content pages - fixed bug where viewAs query parameter was not preserved when navigating from library to playback/course pages; all content pages now properly read and pass viewAsUserId to API calls

### Improved

- **[perf]** Audio course generation performance dramatically improved by properly optimizing TTS batching - fixed root cause where alternating narrator/speaker voices created excessive batches; now all units with same voice/speed/language are grouped together regardless of script position; reduced TTS API calls by 99% from 534 to 3-5 batches per 30-minute course; course generation time reduced from 21+ hours to 15-30 minutes; added admin utility scripts kill-active-course-jobs.ts and reset-course-status.ts for managing course generation
- **[chore]** Fixed 61 ESLint errors across client codebase - eliminated all 57 errors including unused eslint-disable directives (10), nested ternaries (7), testing-library violations (20), await-in-loop patterns (7), promise executor returns (4), continue statements (2), restricted syntax (2), consistent-return (1), and restricted-globals (1); remaining 91 warnings are all @typescript-eslint/no-explicit-any types flagged for future type improvement

### Added

- **[chore]** Utility script for fixing common furigana errors in Japanese dialogues - added fix-furigana-errors.ts script to correct misreadings like この前[ぜん]→この前[まえ], 何[なん]→何[なに] before particles, 私[わたくし]→私[わたし], and other common mistakes; supports filtering by user ID and provides detailed fix reporting

- **[chore]** Production data migration scripts - added three migration scripts to sync local sample content to production database: migrate-sample-courses.ts (migrates 29 sample audio courses), sync-avatar-urls.ts (syncs speaker avatar URLs for sample dialogues), and sync-arabic-avatars.ts (syncs Arabic speaker avatars by name matching); successfully migrated 5 new sample courses and 20 Arabic speaker avatars to production, avoiding the need to regenerate audio and images

### Fixed

- **[fix]** TTS batched audio cutting off speech at segment boundaries - fixed critical bug where SSML marks were placed BEFORE text instead of AFTER, causing speech to be truncated when splitting batched audio at mark timepoints; marks now correctly fire after speech completes, ensuring full audio capture without cutting off words mid-speech; updated splitting logic to extract segments from previous mark to current mark; resolves audio quality issues in batched course generation
- **[fix]** TTS batch size limit causing API failures - added byte limit checking to prevent batches from exceeding Google's 5000 byte SSML limit; batches now automatically split into 4800-byte chunks when needed while preserving voice properties and original indices for correct reassembly; prevents "input.ssml is longer than the limit" errors during course generation
- **[fix]** Client error display bug showing "[object Object]" instead of actual error messages - fixed CourseGenerator and other components to properly extract error messages from nested API response format ({ error: { message } }); users now see helpful messages like "Please verify your email..." instead of confusing error objects
- **[fix]** Production signup "failed to fetch" error with async email queue - resolved issue where users saw network errors despite successful account creation by making verification email sending asynchronous via BullMQ; implemented idempotent signup to handle retry scenarios gracefully (users can retry without "already exists" errors); added comprehensive [SIGNUP] logging for monitoring; added slow request tracking (>5s for signup, >2s for others); improved client error messaging for network failures; signup responses now complete in <2s with email queued in background with 3 automatic retries

### Added

- **[chore]** Admin tools for user email verification management - added 9 utility scripts for debugging and managing users: verify-user-email.ts (manually verify emails), resend-verification-email.ts (resend verification emails), get-verification-link.ts (get verification links), find-unverified-users.ts (find users needing verification), check-user-courses.ts (view user courses), trigger-course-generation.ts (manually trigger generation), check-course-user.ts (get course details), check-db-connection.ts (verify database), find-recent-courses.ts (find recent courses)
- **[fix]** TypeScript compilation errors and ESLint warnings - resolved type errors in courseQueue.ts (Prisma JsonValue casting), auth.ts (proper types for Prisma updates, Express user, JWT payload), and audioExtractorService.ts (removed unused interface, proper type casting); added appropriate eslint-disable comments for necessary console logging; fixed checkGenerationLimit call to include contentType parameter; updated test expectations for isSampleContent field; added test credentials to server/.env.example

### Changed

- **[style]** Restored font sizes to pre-flashcard styling - reverted Japanese text (2.5rem → 1.5rem, weight 600 → 500) and Chinese text (2.5rem → 2.25rem, weight 600 → 500) to original sizes that existed before flashcard feature; the flashcard feature had increased font sizes for card display but unintentionally affected text rendering throughout the entire application
- **[chore]** Code cleanup and environment documentation - removed development console.log statements from client components (AvatarCropperModal, ChunkPackExamplesPage, NarrowListeningCreatorPage, PISessionPage, PlaybackPage); added comprehensive .env.example for client with Stripe and API configuration; expanded server .env.example with all required variables (OAuth, email, AWS, Stripe, admin emails, worker config); updated README with detailed PWA usage instructions including iOS and Android installation steps, offline support details, and service worker caching configuration

### Removed

- **[refactor]** Complete removal of flashcard/SRS feature - removed all flashcard and spaced repetition system functionality including ReviewPage, DeckEditorPage, flashcard components, SRS routes and service, Deck/Card/Review database models, and flashcardsEnabled feature flag; this simplifies the application by ~4,700 lines of code and speeds up audio course generation by eliminating flashcard audio synthesis

### Added

- **[feat]** Progressive Web App (PWA) implementation with offline support - configured VitePWA plugin with service worker and web app manifest; generated PWA icons (192x192, 512x512, apple-touch-icon); created PWAInstallPrompt component with platform-specific install flows for iOS Safari and Android/Chrome; implemented Workbox runtime caching strategies for fonts, API calls (5-minute cache), and audio files (30-day cache); added PWA meta tags for standalone app mode with theme color and viewport-fit configuration
- **[feat]** Mobile touch target optimization for 44px accessibility standard - increased navigation buttons height from 36px to 44px on mobile devices; enlarged user menu button to 44px minimum with proper padding; adjusted library filter buttons vertical padding to achieve 44px height; resized audio player controls (play/pause and repeat buttons) from 40px to 44px for easier tapping
- **[feat]** Sample content onboarding with guided user experience - created SampleContentGuide component to welcome new users and highlight pre-generated content with sample badges; added CustomContentGuide component explaining how to create personalized dialogues and courses; implemented ProtectedByFeatureFlag wrapper component for feature-gated routes; added database migrations for seenSampleContentGuide and seenCustomContentGuide user tracking fields
- **[feat]** Flashcards feature flag for phased rollout - added flashcardsEnabled flag to FeatureFlags database table; updated feature flag hooks and contexts to support new flag; integrated feature flag checks in navigation and route protection
- **[test]** Comprehensive upgrade prompt test coverage for all content creation flows (24 tests total across DialogueGenerator, CourseGenerator, NarrowListeningCreatorPage, PISetupPage, and ChunkPackSetupPage)
- **[feat]** Upgrade prompts when quota limits reached - implemented modal prompts that automatically appear when users hit their generation quotas; integrated into dialogue and course generators; captures quota metadata (used, limit, resetsAt) from 429 error responses; free tier users see lifetime limit messaging with upgrade CTA; paid tier users see monthly reset info; includes e2e test infrastructure improvements (seed script, port fixes, dotenv config)
- **[test]** Updated quota-system e2e tests for tier-based quotas - modified e2e tests to reflect new tier-based quota system with lifetime per-content-type limits for free tier (2 dialogues) instead of weekly limits; updated test assertions to use flexible regex patterns instead of hardcoded values; skipped tests not applicable to free tier (80-89% usage range, quota reset dates); updated error message assertions from "Weekly quota exceeded" to "Quota exceeded"
- **[feat]** Tier-based quota system with lifetime and monthly limits - implemented differentiated quota system for free and paid tiers; free tier has lifetime per-content-type limits (2 dialogues + 1 audio course); paid tier has 30 generations per month combined across all content types; admin users have unlimited access; converted rateLimitGeneration to factory function accepting contentType parameter; updated all route handlers to use new factory pattern; added 39 comprehensive unit tests for quota system; updated integration tests for new quota behavior; updated error messages to be tier-agnostic
- **[feat]** Monthly date utilities for paid tier quota management - added getMonthStart and getNextMonthStart functions to support monthly quota cycle (30 generations per month, resetting on 1st of each month); functions handle month boundaries, year transitions, leap years, and all edge cases; added 26 comprehensive tests covering mid-month scenarios, year boundaries, leap years, and all 12 months validation
- **[feat]** MVP UX improvements for pricing and language selection - replaced "Native Language" with "Primary Language" throughout UI (onboarding and settings); removed country flags from language selection in favor of text-only names (e.g., "Japanese", "Spanish") for a more inclusive design; updated all pricing displays to reflect $10/month with 30 generations per month for paid tier and "2 dialogues + 1 audio course (lifetime)" for free tier; changed quota reset messaging from weekly to monthly cycles
- **[docs]** MVP content topics and pricing decisions - finalized 3 dialogue topics (Meeting Someone New, At a Café/Restaurant, Making Weekend Plans) and 1 audio course topic (Travel & Transportation) for pre-generated sample content; set paid tier pricing at $10/month with 30 items per month; defined free tier limits (2 dialogues + 1 audio course lifetime); decided to replace "native language" terminology with "Primary Language" and remove country flags in favor of language names only
- **[chore]** Beads issue tracking system for MVP planning - initialized Beads as a persistent, git-backed issue tracker for managing the MVP launch roadmap; setup includes global npm installation, git hooks for automatic JSONL sync, MCP server integration with Claude Code, AGENTS.md workflow documentation, and .gitattributes for smart merging; created initial MVP roadmap with 23 tasks organized into 7 epics (pre-generated sample content, onboarding UX improvements, user guidance pulse points, free vs paid tier definition, flashcard improvements, analytics tracking, and final polish)
- **[feat]** Full sentence furigana support for SRS flashcards - flashcards now display furigana for entire sentences instead of just the target vocabulary word, improving reading comprehension and context understanding; added furiganaService using kuroshiro library for automatic furigana generation; implemented smart sentence parsing logic to correctly extract and render vocabulary words with split furigana annotations (e.g., 予[よ]定[てい]); created backfill script for existing cards; added comprehensive FlashCard test coverage; changed English translation toggle default to off for better learning flow; fixed CurrentTextDisplay container height jumping issue
