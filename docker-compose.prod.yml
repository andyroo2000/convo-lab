version: '3.8'

networks:
  convolab-network:
    driver: bridge
  health-network:
    external: true
    name: health-tracker_health-network

volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/convolab-data/postgres
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/convolab-data/redis

services:
  postgres:
    image: postgres:15-alpine
    container_name: convolab-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: languageflow
      POSTGRES_USER: languageflow
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - convolab-network
    mem_limit: 512m
    mem_reservation: 256m
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U languageflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: convolab-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - convolab-network
    mem_limit: 256m
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  furigana:
    image: ghcr.io/andyroo2000/convolab-furigana:latest
    container_name: convolab-furigana
    restart: unless-stopped
    networks:
      - convolab-network
    mem_limit: 256m
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/')"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  server:
    image: ghcr.io/andyroo2000/convolab-server:latest
    container_name: convolab-server
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      FURIGANA_SERVICE_URL: http://furigana:8080
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcloud-key.json
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      JWT_SECRET: ${JWT_SECRET}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      FISH_AUDIO_API_KEY: ${FISH_AUDIO_API_KEY}
    volumes:
      - ./server/gcloud-key.json:/app/gcloud-key.json:ro
    networks:
      - convolab-network
      - health-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      furigana:
        condition: service_started
    mem_limit: 1024m
    mem_reservation: 512m
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  worker:
    image: ghcr.io/andyroo2000/convolab-worker:latest
    container_name: convolab-worker
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcloud-key.json
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      FISH_AUDIO_API_KEY: ${FISH_AUDIO_API_KEY}
    volumes:
      - ./server/gcloud-key.json:/app/gcloud-key.json:ro
    networks:
      - convolab-network
      - health-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    mem_limit: 1536m
    mem_reservation: 512m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
